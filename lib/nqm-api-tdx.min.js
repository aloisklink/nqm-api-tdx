!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("debug"),require("@nqminds/nqm-core-utils"),require("base-64"),require("cross-fetch")):"function"==typeof define&&define.amd?define("nqm-api-tdx",["debug","@nqminds/nqm-core-utils","base-64","cross-fetch"],t):"object"==typeof exports?exports["nqm-api-tdx"]=t(require("debug"),require("@nqminds/nqm-core-utils"),require("base-64"),require("cross-fetch")):e["nqm-api-tdx"]=t(e.debug,e["@nqminds/nqm-core-utils"],e["base-64"],e["cross-fetch"])}(this,function(e,t,r,n){return function(e){function t(n){if(r[n])return r[n].exports;var a=r[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,t),a.l=!0,a.exports}var r={};return t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(t,r){t.exports=e},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.waitForIndex=t.waitForAccount=t.TDXApiError=t.setDefaults=t.handleError=t.fetchWithDeadline=t.checkResponse=t.buildQueryRequest=t.buildFileUploadRequest=t.buildDatabotInstanceRequest=t.buildDatabotHostRequest=t.buildCommandRequest=t.buildAuthenticateRequest=void 0;var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=r(5),o=n(s),c=r(0),i=n(c);i.default.log=console.log.bind(console);var u="undefined"!=typeof window&&window.fetch?window.fetch:o.default,l=u.Request||Request,d=u.Headers||Headers,h=function(e){var t=this,r=(0,i.default)("nqm-api-tdx:fetchWithDeadline");return new Promise(function(n,a){var s=void 0,o=!1;s=t.config.networkTimeout?setTimeout(function(){r("deadline expired after %d ms",t.config.networkTimeout),s=0,o=!0,a(new Error("deadline expired after "+t.config.networkTimeout+" ms"))},t.config.networkTimeout):0;var c=function(){s&&(clearTimeout(s),s=0)};Promise.resolve(u(e)).then(function(e){c(),n(e)}).catch(function(e){c(),o?r("already rejected by timeout, ignoring rejection [%s]",e.message):a(e)})})},m=function(e,t,r,n){var a=JSON.stringify({from:r,failure:JSON.stringify(t),code:e});this.name="TDXApiError",this.code=e,this.message=a,this.failure=t,this.from=r,this.stack=n||(new Error).stack};m.prototype=Object.create(Error.prototype),m.prototype.constructor=m;var f=function(e,t,r){return new m(void 0===e?"n/a":e,t,r,(new Error).stack)},p=function(e,t,r){var n=(this.config.tdxServer||this.config.commandServer||this.config.queryServer)+"/token";return new l(n,{method:"POST",mode:"cors",headers:new d({Authorization:"Basic "+e,"Content-Type":"application/json"}),body:JSON.stringify({grant_type:"client_credentials",ip:t,ttl:r||this.config.accessTokenTTL||3600})})},g=function(e,t,r,n){var a=n?"command":"commandSync";return r=r||"application/json",new l(this.config.commandServer+"/"+a+"/"+e,{method:"POST",mode:"cors",headers:new d({Authorization:"Bearer "+this.accessToken,"Content-Type":r}),body:JSON.stringify(t)})},v=function(e,t){if(!this.config.databotServer)throw new Error("databotServer URL not defined in API config");return new l(this.config.databotServer+"/host/"+e,{method:"POST",mode:"cors",headers:new d({Authorization:"Bearer "+this.accessToken,"Content-Type":"application/json"}),body:JSON.stringify(t)})},b=function(e,t,r,n){var a=void 0;return a=t?"compressedUpload":r?"base64Upload":"upload",new l(this.config.commandServer+"/commandSync/resource/"+e+"/"+a,{method:"POST",mode:"cors",headers:new d({Authorization:"Bearer "+this.accessToken,"Content-Length":n.size,"Content-Disposition":'attachment; filename="'+n.name+'"'}),body:n})},k=function(e,t,r,n){t=t?encodeURIComponent(JSON.stringify(t)):"",r=r?encodeURIComponent(JSON.stringify(r)):"",n=n?encodeURIComponent(JSON.stringify(n)):"";var a=void 0;return a=e.indexOf("?")<0?e+"?filter="+t+"&proj="+r+"&opts="+n:e+"&filter="+t+"&proj="+r+"&opts="+n,new l(""+this.config.queryServer+a,{method:"GET",mode:"cors",headers:new d({Authorization:"Bearer "+this.accessToken,"Content-Type":"application/json","Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"})})},D=function(e){if(!this.config.databotServer)throw new Error("databotServer URL not defined in API config");return new l(this.config.databotServer+"/instance/"+e,{method:"GET",mode:"cors",headers:new d({Authorization:"Bearer "+this.accessToken,"Content-Type":"application/json","Cache-Control":"no-cache",Pragma:"no-cache",Expires:"0"})})},y=function(e,t,r){var n=(0,i.default)("nqm-api-tdx:checkResponse");return"object"===(void 0===t?"undefined":a(t))&&(r=t,t=!!this.config.doNotThrow),r.text().then(function(a){var s=void 0;try{s=JSON.parse(a)}catch(e){n("failed to parse json => assuming non-JSON content type")}if(r.ok)return s?!t&&s.result&&s.result.errors&&s.result.errors.length?Promise.reject(f(409,{code:"DataError",message:s.result.errors.join(", ")},e)):s:a;if(s&&s.error){var o={code:s.error,message:s.error_description};return Promise.reject(f(r.status,o,e))}return Promise.reject(f(r.status,s||a,e))})},R=function(e){var t=(0,i.default)("nqm-api-tdx:setDefaults");if(e.tdxServer=e.tdxServer||e.tdxHost,e.commandServer=e.commandServer||e.commandHost,e.databotServer=e.databotServer||e.databotHost,e.queryServer=e.queryServer||e.queryHost,e.tdxServer&&(!e.queryServer||!e.commandServer)){var r=e.tdxServer.split("://");if(2!==r.length)throw new Error("invalid tdxServer in config - no protocol: "+e.tdxServer);var n=r[0],a=r[1].split(".");if(a.length<3)throw new Error("invalid tdxServer in config - expected sub.domain.tld: "+e.tdxServer);var s=a.slice(1).join(".");e.databotServer=e.databotServer||n+"://databot."+s,e.commandServer=e.commandServer||n+"://cmd."+s,e.queryServer=e.queryServer||n+"://q."+s}e.queryServer=e.queryServer&&e.queryServer+"/v1/",t("using hosts: command %s, databot %s, query %s, auth %s",e.commandServer||"[n/a]",e.databotServer||"[n/a]",e.queryServer||"[n/a]",e.tdxServer||"[n/a]"),e.networkTimeout=void 0===e.networkTimeout?12e4:e.networkTimeout},w=function e(t,r,n,a){var s=this,o=(0,i.default)("nqm-api-tdx:waitForResource");return n=n||0,this.getResource(t).then(function(c){var i=r(c,n);return i instanceof Error?(o("waitForResource - check failed with error [%s]",i.message),Promise.reject(i)):i?c:a>=0&&n>a?(o("giving up after %d attempts",n),Promise.reject(new Error("gave up waiting for "+t+" after "+n+" attempts"))):(o("waiting for %d msec",1e3),new Promise(function(c){setTimeout(function(){o("trying again"),c(e.call(s,t,r,n+1,a))},1e3)}))}).catch(function(c){if("TDXApiError"!==c.name)return Promise.reject(c);try{var i=JSON.parse(c.message),u=JSON.parse(i.failure);return"NotFound"===u.code||"NotFoundError"===u.code||"Unauthorized"===u.code||"UnauthorizedError"===u.code?(o("ignoring error %s",c.message),new Promise(function(o){setTimeout(function(){o(e.call(s,t,r,n+1,a))},1e3)})):Promise.reject(c)}catch(e){return o("failure: [%s]",e.message),Promise.reject(c)}})},A=function(e,t,r){var n=(0,i.default)("nqm-api-tdx:waitForIndex");void 0===r&&(r=-1),t=t||"built";var a="";return w.call(this,e,function(e,s){n("builtIndexCheck: %s",e?e.indexStatus:"no dataset");var o=void 0;return o=!(!e||!e.schemaDefinition||"dataset"===e.schemaDefinition.basedOn[0])||(e&&"error"===e.indexStatus?!!a&&("error"!==a?new Error("index entered error status"):s>Math.min(r,15)&&new Error("index still in error status after "+s+" retries")):!!e&&e.indexStatus===t),e&&!a&&(a=e.indexStatus),o},0,r)},T=function e(t,r,n,a,s){var o=this,c=(0,i.default)("nqm-api-tdx:waitForAccount");return a=a||0,this.getAccount(t).then(function(i){var u=!1;return u=!i||!i.initialised||(!(!r||i.verified)||!(!n||i.approved)),u?s>=0&&a>s?(c("giving up after %d attempts",a),Promise.reject(new Error("gave up waiting for account "+t+" after "+a+" attempts"))):(c("waiting for %d msec",1e3),new Promise(function(i){setTimeout(function(){c("trying again"),i(e.call(o,t,r,n,a+1,s))},1e3)})):i}).catch(function(e){return Promise.reject(e)})};t.buildAuthenticateRequest=p,t.buildCommandRequest=g,t.buildDatabotHostRequest=v,t.buildDatabotInstanceRequest=D,t.buildFileUploadRequest=b,t.buildQueryRequest=k,t.checkResponse=y,t.fetchWithDeadline=h,t.handleError=f,t.setDefaults=R,t.TDXApiError=m,t.waitForAccount=T,t.waitForIndex=A},function(e,r){e.exports=t},function(e,t){e.exports=r},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,t){var r=[],n=!0,a=!1,s=void 0;try{for(var o,c=e[Symbol.iterator]();!(n=(o=c.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,s=e}finally{try{!n&&c.return&&c.return()}finally{if(a)throw s}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(3),l=n(u),d=r(0),h=n(d),m=r(2),f=r(1);h.default.log=console.log.bind(console);var p=(0,h.default)("nqm-api-tdx"),g=(0,h.default)("nqm-api-tdx:error"),v=function(){function e(t){a(this,e),this.config=c({},t),this.accessToken=t.accessToken||t.authToken||"",(0,f.setDefaults)(this.config)}return i(e,[{key:"authenticate",value:function(e,t,r,n){var a=this,s=void 0;"string"!=typeof t?(s=e,n=r,r=t):s=encodeURIComponent(e)+":"+t,s=l.default.encode(s);var o=f.buildAuthenticateRequest.call(this,s,n,r);return f.fetchWithDeadline.call(this,o).then(f.checkResponse.bind(this,"authenticate")).then(function(e){return p(e),a.accessToken=e.access_token,a.accessToken}).catch(function(e){return g("authenticate error: "+e.message),Promise.reject(e)})}},{key:"addAccount",value:function(e,t){var r=this,n=f.buildCommandRequest.call(this,"account/create",e);return f.fetchWithDeadline.call(this,n).catch(function(e){return g("TDXApi.addAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"addAccount")).then(function(n){return t?f.waitForAccount.call(r,e.username,e.verified,e.approved).then(function(){return n}):n})}},{key:"addAccountApplicationConnection",value:function(e,t){var r=this,n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=f.buildCommandRequest.call(this,"applicationConnection/create",{accountId:e});return f.fetchWithDeadline.call(this,a).catch(function(e){return g("TDXApi.addAccountApplicationConnection: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"addAccountApplicationConnection")).then(function(a){if(n){var s=(0,m.shortHash)(t+"-"+e);return f.waitForIndex.call(r,s).then(function(){return a})}return a})}},{key:"approveAccount",value:function(e,t){var r=f.buildCommandRequest.call(this,"account/approve",{username:e,approved:t});return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.approveAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"approveAccount"))}},{key:"deleteAccount",value:function(e){var t=f.buildCommandRequest.call(this,"account/delete",{username:e});return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.deleteAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"deleteAccount"))}},{key:"resetAccount",value:function(e,t){var r=f.buildCommandRequest.call(this,"account/reset",{username:e,key:t});return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.resetAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"resetAccount"))}},{key:"updateAccount",value:function(e,t){var r=f.buildCommandRequest.call(this,"account/update",c({username:e},t));return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.updateAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"addAccount"))}},{key:"verifyAccount",value:function(e,t){var r=f.buildCommandRequest.call(this,"account/verify",{username:e,verified:t});return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.verifyAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"verifyAccount"))}},{key:"addTrustedExchange",value:function(e){var t=f.buildCommandRequest.call(this,"trustedConnection/create",e);return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.addTrustedExchange: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"addTrustedExchange"))}},{key:"addResource",value:function(e,t){var r=this,n=f.buildCommandRequest.call(this,"resource/create",e);return f.fetchWithDeadline.call(this,n).catch(function(e){return g("TDXApi.addResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"addResource")).then(function(e){return t?f.waitForIndex.call(r,e.response.id,!0===t?"":t).then(function(){return e}):e})}},{key:"addResourceAccess",value:function(e,t,r,n){var a=f.buildCommandRequest.call(this,"resourceAccess/add",{rid:e,aid:t,src:r,acc:[].concat(n)});return f.fetchWithDeadline.call(this,a).catch(function(e){return g("TDXApi.addResourceAccess: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"addResourceAccess"))}},{key:"deleteResource",value:function(e){var t=f.buildCommandRequest.call(this,"resource/delete",{id:e});return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.deleteResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"deleteResource"))}},{key:"deleteManyResources",value:function(e){var t=f.buildCommandRequest.call(this,"resource/deleteMany",{payload:e});return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.deleteManyResources: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"deleteManyResources"))}},{key:"fileUpload",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=f.buildFileUploadRequest.call(this,e,n,a,t),c=f.fetchWithDeadline.call(this,s).catch(function(e){return g("TDXApi.fileUpload: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))});return r?c:c.then(function(e){return[e,e.text()]}).then(function(e){var t=o(e,2),r=t[0],n=t[1];return r.ok?Promise.resolve(n):Promise.reject((0,f.handleError)(r.status,{code:"failure",message:n},"fileUpload"))})}},{key:"moveResource",value:function(e,t,r){var n=f.buildCommandRequest.call(this,"resource/move",{id:e,fromParentId:t,toParentId:r});return f.fetchWithDeadline.call(this,n).catch(function(e){return g("TDXApi.moveResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"moveResource"))}},{key:"rebuildResourceIndex",value:function(e){var t=this,r=f.buildCommandRequest.call(this,"resource/index/rebuild",{id:e}),n=void 0;return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.rebuildResourceIndex: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"rebuildIndex")).then(function(e){return n=e,f.waitForIndex.call(t,n.response.id,"built")}).then(function(){return n})}},{key:"removeResourceAccess",value:function(e,t,r,n,a){var s=f.buildCommandRequest.call(this,"resourceAccess/delete",{rid:e,aid:t,by:r,src:n,acc:a});return f.fetchWithDeadline.call(this,s).catch(function(e){return g("TDXApi.removeResourceAccess: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"removeResourceAccess"))}},{key:"setResourceImporting",value:function(e,t){var r=f.buildCommandRequest.call(this,"resource/importing",{id:e,importing:t});return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.setResourceImporting: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"setResourceImporting"))}},{key:"setResourceSchema",value:function(e,t){var r=f.buildCommandRequest.call(this,"resource/schema/set",{id:e,schema:t});return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.setResourceSchema: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"setResourceSchema"))}},{key:"setResourceShareMode",value:function(e,t){var r=f.buildCommandRequest.call(this,"resource/setShareMode",{id:e,shareMode:t});return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.setResourceShareMode: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"setResourceShareMode"))}},{key:"setResourcePermissiveShare",value:function(e,t){var r=f.buildCommandRequest.call(this,"resource/setPermissiveShare",{id:e,permissiveShare:t?"r":""});return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.setResourcePermissiveShare: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"setResourcePermissiveShare"))}},{key:"setResourceTextContent",value:function(e,t){var r=f.buildCommandRequest.call(this,"resource/textContent/set",{id:e,textContent:t});return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.setResourceTextContent: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"setResourceTextContent"))}},{key:"suspendResourceIndex",value:function(e){var t=this,r=f.buildCommandRequest.call(this,"resource/index/suspend",{id:e}),n=void 0;return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.suspendResourceIndex: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"suspendIndex")).then(function(e){return n=e,f.waitForIndex.call(t,n.response.id,"suspended")}).then(function(){return n})}},{key:"truncateResource",value:function(e){var t=f.buildCommandRequest.call(this,"resource/truncate",{id:e});return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.truncateResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"truncateResource"))}},{key:"updateResource",value:function(e,t){var r=f.buildCommandRequest.call(this,"resource/update",c({id:e},t));return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.updateResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"updateResource"))}},{key:"addData",value:function(e,t,r){var n={datasetId:e,payload:[].concat(t)},a=f.buildCommandRequest.call(this,"dataset/data/createMany",n);return f.fetchWithDeadline.call(this,a).catch(function(e){return g("TDXApi.addData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"addData",r))}},{key:"deleteData",value:function(e,t,r){var n={datasetId:e,payload:[].concat(t)},a=f.buildCommandRequest.call(this,"dataset/data/deleteMany",n);return f.fetchWithDeadline.call(this,a).catch(function(e){return g("TDXApi.deleteData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"deleteData",r))}},{key:"deleteDataByQuery",value:function(e,t,r){var n={datasetId:e,query:JSON.stringify(t)},a=f.buildCommandRequest.call(this,"dataset/data/deleteQuery",n);return f.fetchWithDeadline.call(this,a).catch(function(e){return g("TDXApi.deleteDataByQuery: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"deleteDataByQuery",r))}},{key:"patchData",value:function(e,t,r){var n={datasetId:e,payload:[].concat(t)},a=f.buildCommandRequest.call(this,"dataset/data/upsertMany",n);return f.fetchWithDeadline.call(this,a).catch(function(e){return g("TDXApi.patchData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"patchData",r))}},{key:"updateData",value:function(e,t,r,n){var a={datasetId:e,payload:[].concat(t),__upsert:!!r},s=f.buildCommandRequest.call(this,"dataset/data/updateMany",a);return f.fetchWithDeadline.call(this,s).catch(function(e){return g("TDXApi.updateData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"updateData",n))}},{key:"updateDataByQuery",value:function(e,t,r,n){var a={datasetId:e,query:JSON.stringify(t),update:r},s=f.buildCommandRequest.call(this,"dataset/data/updateQuery",a);return f.fetchWithDeadline.call(this,s).catch(function(e){return g("TDXApi.updateDataByQuery: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"updateDataByQuery",n))}},{key:"deleteDatabotHost",value:function(e){var t={payload:e},r=f.buildCommandRequest.call(this,"databot/host/delete",t);return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.deleteDatabotHost: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"deleteDatabotHost"))}},{key:"deleteDatabotInstance",value:function(e){var t={instanceId:[].concat(e)},r=f.buildCommandRequest.call(this,"databot/deleteInstance",t);return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.deleteDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"deleteDatabotInstance"))}},{key:"getDatabotInstance",value:function(e){var t=f.buildDatabotInstanceRequest.call(this,e);return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.getDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getDatabotInstance"))}},{key:"getDatabotInstanceOutput",value:function(e,t){var r=f.buildDatabotInstanceRequest.call(this,"output/"+e+"/"+(t||""));return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.getDatabotInstanceOutput: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getDatabotInstanceOutput"))}},{key:"getDatabotInstanceStatus",value:function(e){var t=f.buildDatabotInstanceRequest.call(this,"status/"+e);return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.getDatabotInstanceStatus: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getDatabotInstanceStatus"))}},{key:"registerDatabotHost",value:function(e){var t=f.buildDatabotHostRequest.call(this,"register",e);return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.registerDatabotHost: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"registerDatabotHost"))}},{key:"sendDatabotHostCommand",value:function(e,t,r,n,a){var s={hostId:t,hostIp:r,hostPort:n,command:e,payload:a},o=f.buildCommandRequest.call(this,"databot/host/command",s);return f.fetchWithDeadline.call(this,o).catch(function(e){return g("TDXApi.sendDatabotHostCommand: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"sendDatabotHostCommand"))}},{key:"startDatabotInstance",value:function(e,t){var r={databotId:e,instanceData:t},n=f.buildCommandRequest.call(this,"databot/startInstance",r);return f.fetchWithDeadline.call(this,n).catch(function(e){return g("TDXApi.startDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"startDatabotInstance"))}},{key:"abortDatabotInstance",value:function(e){var t={instanceId:e},r=f.buildCommandRequest.call(this,"databot/abortInstance",t);return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.abortDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"abortDatabotInstance"))}},{key:"stopDatabotInstance",value:function(e,t){var r={instanceId:e,mode:t},n=f.buildCommandRequest.call(this,"databot/stopInstance",r);return f.fetchWithDeadline.call(this,n).catch(function(e){return g("TDXApi.stopDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"stopDatabotInstance"))}},{key:"updateDatabotHostStatus",value:function(e){var t=f.buildDatabotHostRequest.call(this,"status",e);return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.updateDatabotHostStatus: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"updateDatabotHostStatus"))}},{key:"writeDatabotHostInstanceOutput",value:function(e){var t=f.buildDatabotHostRequest.call(this,"output",e);return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.writeDatabotHostInstanceOutput: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"writeDatabotHostInstanceOutput"))}},{key:"addZoneConnection",value:function(e){var t=f.buildCommandRequest.call(this,"zoneConnection/create",e);return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.addZoneConnection: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"addZoneConnection"))}},{key:"deleteZoneConnection",value:function(e){var t=f.buildCommandRequest.call(this,"zoneConnection/delete",{id:e});return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.deleteZoneConnection: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"deleteZoneConnection"))}},{key:"rollbackCommand",value:function(e){var t=f.buildCommandRequest.call(this,"rollback",{id:e});return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.rollbackCommand: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"rollbackCommand"))}},{key:"createTDXToken",value:function(e,t,r){var n=f.buildQueryRequest.call(this,"token/create",{username:e,ip:t,ttl:r});return f.fetchWithDeadline.call(this,n).catch(function(e){return g("TDXApi.createTDXToken: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"createTDXToken"))}},{key:"exchangeTDXToken",value:function(e,t,r,n){var a=f.buildQueryRequest.call(this,"token/exchange",{token:e,ip:t,exchangeIP:r,ttl:n});return f.fetchWithDeadline.call(this,a).catch(function(e){return g("TDXApi.exchangeTDXToken: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"exchangeTDXToken"))}},{key:"downloadResource",value:function(e){var t=f.buildQueryRequest.call(this,"resources/"+e+"/download");return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.downloadResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))})}},{key:"getAccount",value:function(e){var t=f.buildQueryRequest.call(this,"accounts",{username:e});return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.getAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getAccount")).then(function(e){return e&&e.length?e[0]:null})}},{key:"getAccounts",value:function(e){var t=f.buildQueryRequest.call(this,"accounts",e);return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.getAccounts: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getAccounts"))}},{key:"getAggregateDataStream",value:function(e,t,r){t&&"object"===(void 0===t?"undefined":s(t))&&(t=JSON.stringify(t));var n="resources/"+e+"/"+(r?"ndaggregate":"aggregate")+"?pipeline="+t,a=f.buildQueryRequest.call(this,n);return f.fetchWithDeadline.call(this,a).catch(function(e){return g("TDXApi.getAggregateData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))})}},{key:"getAggregateData",value:function(e,t,r){return this.getAggregateDataStream(e,t,r).then(f.checkResponse.bind(this,"getAggregateData"))}},{key:"getAuthenticatedAccount",value:function(){var e=f.buildQueryRequest.call(this,"auth-account");return f.fetchWithDeadline.call(this,e).catch(function(e){return g("TDXApi.getAuthenticatedAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getAuthenticatedAccount"))}},{key:"getDataStream",value:function(e,t,r,n,a){var s="resources/"+e+"/"+(a?"nddata":"data"),o=f.buildQueryRequest.call(this,s,t,r,n);return f.fetchWithDeadline.call(this,o).catch(function(e){return g("TDXApi.getDataStream: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))})}},{key:"getData",value:function(e,t,r,n,a){return this.getDataStream(e,t,r,n,a).then(f.checkResponse.bind(this,"getData"))}},{key:"getNDData",value:function(e,t,r,n){return this.getDataStream(e,t,r,n,!0).then(f.checkResponse.bind(this,"getNDData"))}},{key:"getDatasetDataStream",value:function(e,t,r,n,a){return this.getDataStream(e,t,r,n,a)}},{key:"getDatasetData",value:function(e,t,r,n,a){return this.getData(e,t,r,n,a)}},{key:"getDataCount",value:function(e,t){var r=f.buildQueryRequest.call(this,"resources/"+e+"/count",t);return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.getDataCount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getDataCount"))}},{key:"getDatasetDataCount",value:function(e,t){return this.getDataCount(e,t)}},{key:"getDistinct",value:function(e,t,r,n,a){var s=f.buildQueryRequest.call(this,"resources/"+e+"/distinct?key="+t,r,n,a);return f.fetchWithDeadline.call(this,s).catch(function(e){return g("TDXApi.getDistinct: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getDistinct"))}},{key:"getResource",value:function(e,t){var r=this,n=f.buildQueryRequest.call(this,"resources/"+e);return f.fetchWithDeadline.call(this,n).catch(function(e){return g("TDXApi.getResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(function(e){return t?e.ok?e.json():404===e.status?null:f.checkResponse.call(r,"getResource",e):f.checkResponse.call(r,"getResource",e)})}},{key:"getResourceAccess",value:function(e,t,r,n){var a=this,s=f.buildQueryRequest.call(this,"resources/"+e+"/access",t,r,n);return f.fetchWithDeadline.call(this,s).catch(function(e){return g("TDXApi.getResourceAccess: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(function(e){return f.checkResponse.call(a,"getResourceAccess",e)})}},{key:"getResourceAncestors",value:function(e){var t=f.buildQueryRequest.call(this,"resources/"+e+"/ancestors");return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.getDatasetAncestors: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getResourceAncestors"))}},{key:"getResources",value:function(e,t,r){var n=f.buildQueryRequest.call(this,"resources",e,t,r);return f.fetchWithDeadline.call(this,n).catch(function(e){return g("TDXApi.getResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getResources"))}},{key:"getResourcesWithSchema",value:function(e){var t={"schemaDefinition.parent":e};return this.getResources(t)}},{key:"getTDXToken",value:function(e){var t=f.buildQueryRequest.call(this,"tdx-token/"+e);return f.fetchWithDeadline.call(this,t).catch(function(e){return g("TDXApi.getTDXToken: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"getTDXToken"))}},{key:"getZone",value:function(e){return this.getAccount(e)}},{key:"isInGroup",value:function(e,t){var r={aid:e,"r.0":{$exists:!0},grp:"m"};return this.getResourceAccess(t,r).then(function(e){return!!e.length})}},{key:"validateTDXToken",value:function(e,t){var r=f.buildQueryRequest.call(this,"token/validate",{token:e,ip:t});return f.fetchWithDeadline.call(this,r).catch(function(e){return g("TDXApi.validateTDXToken: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(f.checkResponse.bind(this,"validateTDXToken"))}}]),e}();t.default=v,e.exports=t.default},function(e,t){e.exports=n}])});