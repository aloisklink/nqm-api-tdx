!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("bluebird"),require("isomorphic-fetch")):"function"==typeof define&&define.amd?define("nqm-api-tdx",["bluebird","isomorphic-fetch"],t):"object"==typeof exports?exports["nqm-api-tdx"]=t(require("bluebird"),require("isomorphic-fetch")):e["nqm-api-tdx"]=t(e.bluebird,e["isomorphic-fetch"])}(this,function(e,t){return function(e){function t(o){if(r[o])return r[o].exports;var n=r[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,o){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:o})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=2)}([function(t,r){t.exports=e},function(e,r){e.exports=t},function(e,t,r){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},s=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),u=r(0),c=o(u),i=r(1),d=o(i),l=function(e){return e.json().then(function(t){return e.ok?t:c.default.reject(new Error(t.error||JSON.stringify(t)))})},f=function(e){if(e.tdxHost&&(!e.queryHost||!e.commandHost)){var t=e.tdxHost.split("://");if(2!==t.length)throw new Error("invalid tdxHost in config - no protocol: "+e.tdxHost);var r=t[0],o=t[1].split(".");if(o.length<3)throw new Error("invalid tdxHost in config - expected sub.domain.tld: "+e.tdxHost);var n=o.slice(1).join(".");e.commandHost=e.commandHost||r+"://cmd."+n,e.queryHost=e.queryHost||r+"://q."+n,e.databotHost=e.databotHost||r+"://databot."+n,console.log("defaulted hosts to %s, %s, %s",e.commandHost,e.queryHost,e.databotHost)}},h=function(){function e(t){n(this,e),this.config=t,this.accessToken=t.accessToken||"",f(this.config)}return s(e,[{key:"buildCommandRequest",value:function(e,t){return new Request(this.config.commandHost+"/commandSync/"+e,{method:"POST",mode:"cors",headers:new Headers({Authorization:"Bearer "+this.accessToken,"Content-Type":"application/json"}),body:JSON.stringify(t)})}},{key:"buildQueryRequest",value:function(e,t,r,o){t=t?JSON.stringify(t):"",r=r?JSON.stringify(r):"",o=o?JSON.stringify(o):"";var n=e+"?filter="+t+"&proj="+r+"&opts="+o;return new Request(this.config.queryHost+"/v1/"+n,{method:"GET",mode:"cors",headers:new Headers({Authorization:"Bearer "+this.accessToken,"Content-Type":"application/json"})})}},{key:"authenticate",value:function(e,t){var r=this,o=void 0;o=void 0===t?e:e+":"+t;var n=(this.config.tdxHost||this.config.commandHost||this.config.queryHost)+"/token",a=new Request(n,{method:"POST",mode:"cors",headers:new Headers({Authorization:"Basic "+o,"Content-Type":"application/json"}),body:JSON.stringify({grant_type:"client_credentials",ttl:this.config.accessTokenTTL||3600})});return(0,d.default)(a).then(l).then(function(e){return console.log(e),r.accessToken=e.access_token,r.accessToken}).catch(function(e){return console.log("error: "+e.message),c.default.reject(e)})}},{key:"addAccount",value:function(e){var t=this.buildCommandRequest("account/create",e);return(0,d.default)(t).catch(function(e){return console.error("TDXApi.addAccount: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"addTrustedExchange",value:function(e){var t=this.buildCommandRequest("trustedConnection/create",e);return(0,d.default)(t).catch(function(e){return console.error("TDXApi.addTrustedExchange: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"addResource",value:function(e){var t=this.buildCommandRequest("resource/create",e);return(0,d.default)(t).catch(function(e){return console.error("TDXApi.addResource: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"deleteResource",value:function(e){var t=this.buildCommandRequest("resource/delete",{id:e});return(0,d.default)(t).catch(function(e){return console.error("TDXApi.deleteResource: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"addResourceAccess",value:function(e,t,r,o){var n=this.buildCommandRequest("resourceAccess/add",{rid:e,aid:t,src:r,acc:o});return(0,d.default)(n).catch(function(e){return console.error("TDXApi.addResourceAccess: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"removeResourceAccess",value:function(e,t,r,o,n){var a=this.buildCommandRequest("resourceAccess/delete",{rid:e,aid:t,by:r,src:o,acc:n});return(0,d.default)(a).catch(function(e){return console.error("TDXApi.removeResourceAccess: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"setResourceShareMode",value:function(e,t){var r=this.buildCommandRequest("resource/setShareMode",{id:e,shareMode:t});return(0,d.default)(r).catch(function(e){return console.error("TDXApi.setResourceShareMode: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"setResourcePermissiveShare",value:function(e,t){var r=this.buildCommandRequest("resource/setPermissiveShare",{id:e,permissiveShare:t?"r":""});return(0,d.default)(r).catch(function(e){return console.error("TDXApi.setResourcePermissiveShare: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"updateData",value:function(e,t,r){var o={datasetId:e,payload:[].concat(t),__upsert:!!r},n=this.buildCommandRequest("dataset/data/updateMany",o);return(0,d.default)(n).catch(function(e){return console.error("TDXApi.updateData: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"patchData",value:function(e,t){var r={datasetId:e,payload:[].concat(t)},o=this.buildCommandRequest("dataset/data/upsertMany",r);return(0,d.default)(o).catch(function(e){return console.error("TDXApi.patchData: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"deleteData",value:function(e,t){var r=a({datasetId:e},t),o=this.buildCommandRequest("dataset/data/delete",r);return(0,d.default)(o).catch(function(e){return console.error("TDXApi.deleteData: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"getZone",value:function(e){var t=this.buildQueryRequest("zones",{username:e});return(0,d.default)(t).catch(function(e){return console.error("TDXApi.getZone: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"getResource",value:function(e){var t=this.buildQueryRequest("datasets/"+e);return(0,d.default)(t).catch(function(e){return console.error("TDXApi.getResource: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"getDatasetAncestors",value:function(e){var t=this.buildQueryRequest("datasets/"+e+"/ancestors");return(0,d.default)(t).catch(function(e){return console.error("TDXApi.getDatasetAncestors: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"getDatasetData",value:function(e,t,r,o){var n=this.buildQueryRequest("datasets/"+e+"/data",t,r,o);return(0,d.default)(n).catch(function(e){return console.error("TDXApi.getDatasetData: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"getDatasetDataCount",value:function(e,t){var r=this.buildQueryRequest("datasets/"+e+"/count",t);return(0,d.default)(r).catch(function(e){return console.error("TDXApi.getDatasetDataCount: %s",e.message),c.default.reject(new Error(e.message+" - [network error]"))}).then(l)}},{key:"waitForResource",value:function(e,t,r,o){var n=this;return r=r||0,this.getDataset(e).then(function(a){var s=t(a,r);return s instanceof Error?(console.log("waitForResource - check failed with error [%s]",s.message),c.default.reject(s)):s?a:o>=0&&r>o?(console.log("waitForResource - giving up after %d attempts",r),c.default.reject(new Error("gave up waiting for "+e+" after "+r+" attempts"))):(console.log("waitForResource - waiting for %d msec",1e3),c.default.delay(1e3).then(function(){return n.waitForResource(e,t,r+1,o)}))}).catch(function(a){if("TDXApiError"!==a.name)return c.default.reject(a);try{var s=JSON.parse(a.message),u=JSON.parse(s.failure);return"NotFoundError"===u.code||"UnauthorizedError"===u.code?(console.log("waitForResource - ignoring error %s",a.message),c.default.delay(1e3).then(function(){return n.waitForResource(e,t,r+1,o)})):c.default.reject(a)}catch(e){return c.default.reject(a)}})}},{key:"waitForIndex",value:function(e,t,r){void 0===r&&(r=-1),t=t||"built";var o="",n=function(e,n){console.log("builtIndexCheck: %s",e?e.indexStatus:"no dataset");var a=void 0;return a=e&&"error"===e.indexStatus?!o||("error"!==o?new Error("index entered error status"):!(n>Math.min(r,15))||new Error("index still in error status after "+n+" retries")):!!e&&e.indexStatus===t,e&&!o&&(o=e.indexStatus),a};return this.waitForResource(e,n,0,r)}}]),e}();t.default=h,e.exports=t.default}])});