!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r(require("debug"),require("base-64"),require("isomorphic-fetch")):"function"==typeof define&&define.amd?define("nqm-api-tdx",["debug","base-64","isomorphic-fetch"],r):"object"==typeof exports?exports["nqm-api-tdx"]=r(require("debug"),require("base-64"),require("isomorphic-fetch")):e["nqm-api-tdx"]=r(e.debug,e["base-64"],e["isomorphic-fetch"])}(this,function(e,r,t){return function(e){function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}var t={};return r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="",r(r.s=4)}([function(r,t){r.exports=e},function(e,r,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.waitForIndex=r.TDXApiError=r.setDefaults=r.handleError=r.checkResponse=r.buildQueryRequest=r.buildCommandRequest=void 0;var n=t(0),s=function(e){return e&&e.__esModule?e:{default:e}}(n),a=function(e,r){this.name="TDXApiError",this.message=e||"no message given",this.stack=r||(new Error).stack};a.prototype=Object.create(Error.prototype),a.prototype.constructor=a;var o=function(e,r,t){var n={from:e,failure:JSON.stringify(r),code:void 0===t?"n/a":t};return new a(JSON.stringify(n),(new Error).stack)},u=function(e,r,t,n){var s=n?"command":"commandSync";return t=t||"application/json",new Request(this.config.commandServer+"/"+s+"/"+e,{method:"POST",mode:"cors",headers:new Headers({Authorization:"Bearer "+this.accessToken,"Content-Type":t}),body:JSON.stringify(r)})},c=function(e,r,t,n){r=r?JSON.stringify(r):"",t=t?JSON.stringify(t):"",n=n?JSON.stringify(n):"";var s=void 0;return s=e.indexOf("?")<0?e+"?filter="+r+"&proj="+t+"&opts="+n:e+"&filter="+r+"&proj="+t+"&opts="+n,new Request(""+this.config.queryServer+s,{method:"GET",mode:"cors",headers:new Headers({Authorization:"Bearer "+this.accessToken,"Content-Type":"application/json"})})},i=function(e,r){return r.json().then(function(t){if(r.ok)return Promise.resolve(t);if(t.error){var n={code:t.error,message:t.error_description};return Promise.reject(o(e,n,r.status))}return Promise.reject(o(e,t,r.status))})},d=function(e){var r=(0,s.default)("nqm-api-tdx:setDefaults");if(e.tdxServer=e.tdxServer||e.tdxHost,e.commandServer=e.commandServer||e.commandHost,e.databotServer=e.databotServer||e.databotHost,e.queryServer=e.queryServer||e.queryHost,e.tdxServer&&(!e.queryServer||!e.commandServer)){var t=e.tdxServer.split("://");if(2!==t.length)throw new Error("invalid tdxServer in config - no protocol: "+e.tdxServer);var n=t[0],a=t[1].split(".");if(a.length<3)throw new Error("invalid tdxServer in config - expected sub.domain.tld: "+e.tdxServer);var o=a.slice(1).join(".");e.commandServer=e.commandServer||n+"://cmd."+o,e.queryServer=e.queryServer||n+"://q."+o+"/v1/",e.databotServer=e.databotServer||n+"://databot."+o,r("defaulted hosts to %s, %s, %s",e.commandServer,e.queryServer,e.databotServer)}},l=function e(r,t,n,a){var o=this,u=(0,s.default)("nqm-api-tdx:waitForResource");return n=n||0,this.getResource(r).then(function(s){var c=t(s,n);return c instanceof Error?(u("waitForResource - check failed with error [%s]",c.message),Promise.reject(c)):c?s:a>=0&&n>a?(u("giving up after %d attempts",n),Promise.reject(new Error("gave up waiting for "+r+" after "+n+" attempts"))):(u("waiting for %d msec",1e3),new Promise(function(s){setTimeout(function(){u("trying again"),s(e.call(o,r,t,n+1,a))},1e3)}))}).catch(function(s){if("TDXApiError"!==s.name)return Promise.reject(s);try{var c=JSON.parse(s.message),i=JSON.parse(c.failure);return"NotFoundError"===i.code||"UnauthorizedError"===i.code?(u("ignoring error %s",s.message),new Promise(function(s){setTimeout(function(){s(e.call(o,r,t,n+1,a))},1e3)})):Promise.reject(s)}catch(e){return u("failure: [%s]",e.message),Promise.reject(s)}})},m=function(e,r,t){var n=(0,s.default)("nqm-api-tdx:waitForIndex");void 0===t&&(t=-1),r=r||"built";var a="";return l.call(this,e,function(e,s){n("builtIndexCheck: %s",e?e.indexStatus:"no dataset");var o=void 0;return o=e&&"error"===e.indexStatus?!a||("error"!==a?new Error("index entered error status"):!(s>Math.min(t,15))||new Error("index still in error status after "+s+" retries")):!!e&&e.indexStatus===r,e&&!a&&(a=e.indexStatus),o},0,t)};r.buildCommandRequest=u,r.buildQueryRequest=c,r.checkResponse=i,r.handleError=o,r.setDefaults=d,r.TDXApiError=a,r.waitForIndex=m},function(e,t){e.exports=r},function(e,r){e.exports=t},function(e,r,t){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function s(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},o=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),u=t(3),c=n(u),i=t(2),d=n(i),l=t(0),m=n(l),h=t(1),f=(0,m.default)("nqm-api-tdx"),p=(0,m.default)("nqm-api-tdx:error"),v=function(){function e(r){s(this,e),this.config=r,this.accessToken=r.accessToken||"",(0,h.setDefaults)(this.config)}return o(e,[{key:"authenticate",value:function(e,r,t){var n=this,s=void 0;"string"!=typeof r?(s=e,t=r):s=encodeURIComponent(e)+":"+r,s=d.default.encode(s);var a=(this.config.tdxServer||this.config.commandServer||this.config.queryServer)+"/token",o=new Request(a,{method:"POST",mode:"cors",headers:new Headers({Authorization:"Basic "+s,"Content-Type":"application/json"}),body:JSON.stringify({grant_type:"client_credentials",ttl:t||this.config.accessTokenTTL||3600})});return(0,c.default)(o).then(h.checkResponse.bind(null,"authenticate")).then(function(e){return f(e),n.accessToken=e.access_token,n.accessToken}).catch(function(e){return p("error: "+e.message),Promise.reject(e)})}},{key:"addAccount",value:function(e){var r=h.buildCommandRequest.call(this,"account/create",e);return(0,c.default)(r).catch(function(e){return p("TDXApi.addAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addAccount"))}},{key:"approveAccount",value:function(e,r){var t=h.buildCommandRequest.call(this,"account/approve",{username:e,approved:r});return(0,c.default)(t).catch(function(e){return p("TDXApi.approveAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"approveAccount"))}},{key:"deleteAccount",value:function(e){var r=h.buildCommandRequest.call(this,"account/delete",{username:e});return(0,c.default)(r).catch(function(e){return p("TDXApi.deleteAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteAccount"))}},{key:"resetAccount",value:function(e,r){var t=h.buildCommandRequest.call(this,"account/reset",{username:e,key:r});return(0,c.default)(t).catch(function(e){return p("TDXApi.resetAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"resetAccount"))}},{key:"updateAccount",value:function(e,r){var t=h.buildCommandRequest.call(this,"account/update",a({username:e},r));return(0,c.default)(t).catch(function(e){return p("TDXApi.updateAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addAccount"))}},{key:"verifyAccount",value:function(e,r){var t=h.buildCommandRequest.call(this,"account/verify",{username:e,verified:r});return(0,c.default)(t).catch(function(e){return p("TDXApi.verifyAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"verifyAccount"))}},{key:"addTrustedExchange",value:function(e){var r=h.buildCommandRequest.call(this,"trustedConnection/create",e);return(0,c.default)(r).catch(function(e){return p("TDXApi.addTrustedExchange: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addTrustedExchange"))}},{key:"addResource",value:function(e,r){var t=this,n=h.buildCommandRequest.call(this,"resource/create",e);return(0,c.default)(n).catch(function(e){return p("TDXApi.addResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addResource")).then(function(e){return r?h.waitForIndex.call(t,e.response.id).then(function(){return e}):e})}},{key:"addResourceAccess",value:function(e,r,t,n){var s=h.buildCommandRequest.call(this,"resourceAccess/add",{rid:e,aid:r,src:t,acc:[].concat(n)});return(0,c.default)(s).catch(function(e){return p("TDXApi.addResourceAccess: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addResourceAccess"))}},{key:"deleteResource",value:function(e){var r=h.buildCommandRequest.call(this,"resource/delete",{id:e});return(0,c.default)(r).catch(function(e){return p("TDXApi.deleteResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteResource"))}},{key:"deleteManyResources",value:function(e){var r=h.buildCommandRequest.call(this,"resource/deleteMany",{payload:e});return(0,c.default)(r).catch(function(e){return p("TDXApi.deleteManyResources: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteManyResources"))}},{key:"fileUpload",value:function(e,r,t){var n=new Request(this.config.commandServer+"/commandSync/resource/"+e+"/upload",{method:"POST",mode:"cors",headers:new Headers({Authorization:"Bearer "+this.accessToken,"Content-Disposition":'attachment; filename="'+r.name+'"',"Content-Length":r.size}),body:r}),s=(0,c.default)(n).catch(function(e){return p("TDXApi.fileUpload: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))});return t?s:s.then(function(e){return[e,e.text()]}).spread(function(e,r){return e.ok?Promise.resolve(r):Promise.reject((0,h.handleError)("fileUpload",{code:"failure",message:r}))})}},{key:"moveResource",value:function(e,r,t){var n=h.buildCommandRequest.call(this,"resource/move",{id:e,fromParentId:r,toParentId:t});return(0,c.default)(n).catch(function(e){return p("TDXApi.moveResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"moveResource"))}},{key:"rebuildResourceIndex",value:function(e){var r=this,t=h.buildCommandRequest.call(this,"resource/index/rebuild",{id:e}),n=void 0;return(0,c.default)(t).catch(function(e){return p("TDXApi.rebuildResourceIndex: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"rebuildIndex")).then(function(e){return n=e,h.waitForIndex.call(r,n.response.id,"built")}).then(function(){return n})}},{key:"removeResourceAccess",value:function(e,r,t,n,s){var a=h.buildCommandRequest.call(this,"resourceAccess/delete",{rid:e,aid:r,by:t,src:n,acc:s});return(0,c.default)(a).catch(function(e){return p("TDXApi.removeResourceAccess: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"removeResourceAccess"))}},{key:"setResourceSchema",value:function(e,r){var t=h.buildCommandRequest.call(this,"resource/schema/set",{id:e,schema:r});return(0,c.default)(t).catch(function(e){return p("TDXApi.setResourceSchema: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"setResourceSchema"))}},{key:"setResourceShareMode",value:function(e,r){var t=h.buildCommandRequest.call(this,"resource/setShareMode",{id:e,shareMode:r});return(0,c.default)(t).catch(function(e){return p("TDXApi.setResourceShareMode: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"setResourceShareMode"))}},{key:"setResourcePermissiveShare",value:function(e,r){var t=h.buildCommandRequest.call(this,"resource/setPermissiveShare",{id:e,permissiveShare:r?"r":""});return(0,c.default)(t).catch(function(e){return p("TDXApi.setResourcePermissiveShare: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"setResourcePermissiveShare"))}},{key:"suspendResourceIndex",value:function(e){var r=this,t=h.buildCommandRequest.call(this,"resource/index/suspend",{id:e}),n=void 0;return(0,c.default)(t).catch(function(e){return p("TDXApi.suspendResourceIndex: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"suspendIndex")).then(function(e){return n=e,h.waitForIndex.call(r,n.response.id,"suspended")}).then(function(){return n})}},{key:"truncateResource",value:function(e){var r=h.buildCommandRequest.call(this,"resource/truncate",{id:e});return(0,c.default)(r).catch(function(e){return p("TDXApi.truncateResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"truncateResource"))}},{key:"updateResource",value:function(e,r){var t=h.buildCommandRequest.call(this,"resource/update",a({id:e},r));return(0,c.default)(t).catch(function(e){return p("TDXApi.updateResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"updateResource"))}},{key:"addData",value:function(e,r){var t={datasetId:e,payload:[].concat(r)},n=h.buildCommandRequest.call(this,"dataset/data/createMany",t);return(0,c.default)(n).catch(function(e){return p("TDXApi.createData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"updateData"))}},{key:"deleteData",value:function(e,r){var t={datasetId:e,payload:[].concat(r)},n=h.buildCommandRequest.call(this,"dataset/data/deleteMany",t);return(0,c.default)(n).catch(function(e){return p("TDXApi.deleteData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteData"))}},{key:"deleteDataByQuery",value:function(e,r){var t={datasetId:e,query:r},n=h.buildCommandRequest.call(this,"dataset/data/deleteQuery",t);return(0,c.default)(n).catch(function(e){return p("TDXApi.deleteDataByQuery: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteDataByQuery"))}},{key:"patchData",value:function(e,r){var t={datasetId:e,payload:[].concat(r)},n=h.buildCommandRequest.call(this,"dataset/data/upsertMany",t);return(0,c.default)(n).catch(function(e){return p("TDXApi.patchData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"patchData"))}},{key:"updateData",value:function(e,r,t){var n={datasetId:e,payload:[].concat(r),__upsert:!!t},s=h.buildCommandRequest.call(this,"dataset/data/updateMany",n);return(0,c.default)(s).catch(function(e){return p("TDXApi.updateData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"updateData"))}},{key:"updateDataByQuery",value:function(e,r,t){var n={datasetId:e,query:r,update:t},s=h.buildCommandRequest.call(this,"dataset/data/updateQuery",n);return(0,c.default)(s).catch(function(e){return p("TDXApi.updateDataByQuery: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"updateDataByQuery"))}},{key:"deleteDatabotInstance",value:function(e){var r={instanceId:e},t=h.buildCommandRequest.call(this,"databot/deleteInstance",r);return(0,c.default)(t).catch(function(e){return p("TDXApi.deleteDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteDatabotInstance"))}},{key:"sendDatabotHostCommand",value:function(e,r,t,n){var s={hostId:r,hostIp:t,hostPort:n,command:e},a=h.buildCommandRequest.call(this,"databot/host/command",s);return(0,c.default)(a).catch(function(e){return p("TDXApi.sendDatabotHostCommand: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"sendDatabotHostCommand"))}},{key:"startDatabotInstance",value:function(e,r){var t={databotId:e,instanceData:r},n=h.buildCommandRequest.call(this,"databot/startInstance",t);return(0,c.default)(n).catch(function(e){return p("TDXApi.startDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"startDatabotInstance"))}},{key:"stopDatabotInstance",value:function(e,r){var t={instanceId:e,mode:r},n=h.buildCommandRequest.call(this,"databot/stopInstance",t);return(0,c.default)(n).catch(function(e){return p("TDXApi.stopDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"stopDatabotInstance"))}},{key:"getDatasetData",value:function(e,r,t,n){var s=h.buildQueryRequest.call(this,"datasets/"+e+"/data",r,t,n);return(0,c.default)(s).catch(function(e){return p("TDXApi.getDatasetData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getDatasetData"))}},{key:"getDatasetDataCount",value:function(e,r){var t=h.buildQueryRequest.call(this,"datasets/"+e+"/count",r);return(0,c.default)(t).catch(function(e){return p("TDXApi.getDatasetDataCount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getDatasetDataCount"))}},{key:"getDistinct",value:function(e,r,t,n,s){var a=h.buildQueryRequest.call(this,"datasets/"+e+"/distinct?key="+r,t,n,s);return(0,c.default)(a).catch(function(e){return p("TDXApi.getDistinct: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getDatasetData"))}},{key:"getResource",value:function(e,r){var t=h.buildQueryRequest.call(this,"resources/"+e);return(0,c.default)(t).catch(function(e){return p("TDXApi.getResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(function(e){return r?e.ok?e.json():404===e.status?null:(0,h.checkResponse)("getResource",e):(0,h.checkResponse)("getResource",e)})}},{key:"getResourceAncestors",value:function(e){var r=h.buildQueryRequest.call(this,"datasets/"+e+"/ancestors");return(0,c.default)(r).catch(function(e){return p("TDXApi.getDatasetAncestors: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getResourceAncestors"))}},{key:"getResources",value:function(e,r,t){var n=h.buildQueryRequest.call(this,"resources",e,r,t);return(0,c.default)(n).catch(function(e){return p("TDXApi.getResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getResources"))}},{key:"getResourcesWithSchema",value:function(e){var r={"schemaDefinition.parent":e};return this.getResources(r)}},{key:"getTDXToken",value:function(e){var r=h.buildQueryRequest.call(this,"tdx-token/"+e);return(0,c.default)(r).catch(function(e){return p("TDXApi.getTDXToken: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getTDXToken"))}},{key:"getZone",value:function(e){var r=h.buildQueryRequest.call(this,"zones",{username:e});return(0,c.default)(r).catch(function(e){return p("TDXApi.getZone: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getZone"))}}]),e}();r.default=v,e.exports=r.default}])});