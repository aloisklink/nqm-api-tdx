!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("debug"),require("base-64"),require("isomorphic-fetch")):"function"==typeof define&&define.amd?define("nqm-api-tdx",["debug","base-64","isomorphic-fetch"],t):"object"==typeof exports?exports["nqm-api-tdx"]=t(require("debug"),require("base-64"),require("isomorphic-fetch")):e["nqm-api-tdx"]=t(e.debug,e["base-64"],e["isomorphic-fetch"])}(this,function(e,t,r){return function(e){function t(n){if(r[n])return r[n].exports;var s=r[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var r={};return t.m=e,t.c=r,t.i=function(e){return e},t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=4)}([function(t,r){t.exports=e},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TDXApiError=t.setDefaults=t.handleError=t.checkResponse=void 0;var n=r(0),s=function(e){return e&&e.__esModule?e:{default:e}}(n),o=function(e,t){this.name="TDXApiError",this.message=e||"no message given",this.stack=t||(new Error).stack};o.prototype=Object.create(Error.prototype),o.prototype.constructor=o;var a=function(e,t,r){var n={from:e,failure:JSON.stringify(t),code:void 0===r?"n/a":r};return new o(JSON.stringify(n),(new Error).stack)},u=function(e,t){return t.json().then(function(r){if(t.ok)return Promise.resolve(r);if(r.error){var n={code:r.error,message:r.error_description};return Promise.reject(a(e,n,t.status))}return Promise.reject(a(e,r,t.status))})},c=function(e){var t=(0,s.default)("nqm-api-tdx:setDefaults");if(e.tdxHost&&(!e.queryHost||!e.commandHost)){var r=e.tdxHost.split("://");if(2!==r.length)throw new Error("invalid tdxHost in config - no protocol: "+e.tdxHost);var n=r[0],o=r[1].split(".");if(o.length<3)throw new Error("invalid tdxHost in config - expected sub.domain.tld: "+e.tdxHost);var a=o.slice(1).join(".");e.commandHost=e.commandHost||n+"://cmd."+a,e.queryHost=e.queryHost||n+"://q."+a+"/v1/",e.databotHost=e.databotHost||n+"://databot."+a,t("defaulted hosts to %s, %s, %s",e.commandHost,e.queryHost,e.databotHost)}};t.checkResponse=u,t.handleError=a,t.setDefaults=c,t.TDXApiError=o},function(e,r){e.exports=t},function(e,t){e.exports=r},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},a=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),u=r(3),c=n(u),i=r(2),d=n(i),l=r(0),m=n(l),h=r(1),f=(0,m.default)("nqm-api-tdx"),p=(0,m.default)("nqm-api-tdx:error"),g=function(){function e(t){s(this,e),this.config=t,this.accessToken=t.accessToken||"",(0,h.setDefaults)(this.config)}return a(e,[{key:"buildCommandRequest",value:function(e,t,r){return r=r||"application/json",new Request(this.config.commandHost+"/commandSync/"+e,{method:"POST",mode:"cors",headers:new Headers({Authorization:"Bearer "+this.accessToken,"Content-Type":r}),body:JSON.stringify(t)})}},{key:"buildQueryRequest",value:function(e,t,r,n){t=t?JSON.stringify(t):"",r=r?JSON.stringify(r):"",n=n?JSON.stringify(n):"";var s=void 0;return s=e.indexOf("?")<0?e+"?filter="+t+"&proj="+r+"&opts="+n:e+"&filter="+t+"&proj="+r+"&opts="+n,new Request(""+this.config.queryHost+s,{method:"GET",mode:"cors",headers:new Headers({Authorization:"Bearer "+this.accessToken,"Content-Type":"application/json"})})}},{key:"authenticate",value:function(e,t){var r=this,n=void 0;n=void 0===t?e:encodeURIComponent(e)+":"+t,n=d.default.encode(n);var s=(this.config.tdxHost||this.config.commandHost||this.config.queryHost)+"/token",o=new Request(s,{method:"POST",mode:"cors",headers:new Headers({Authorization:"Basic "+n,"Content-Type":"application/json"}),body:JSON.stringify({grant_type:"client_credentials",ttl:this.config.accessTokenTTL||3600})});return(0,c.default)(o).then(h.checkResponse.bind(null,"authenticate")).then(function(e){return f(e),r.accessToken=e.access_token,r.accessToken}).catch(function(e){return p("error: "+e.message),Promise.reject(e)})}},{key:"addAccount",value:function(e){var t=this.buildCommandRequest("account/create",e);return(0,c.default)(t).catch(function(e){return p("TDXApi.addAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addAccount"))}},{key:"updateAccount",value:function(e,t){var r=this.buildCommandRequest("account/update",o({username:e},t));return(0,c.default)(r).catch(function(e){return p("TDXApi.updateAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addAccount"))}},{key:"approveAccount",value:function(e,t){var r=this.buildCommandRequest("account/approve",{username:e,approved:t});return(0,c.default)(r).catch(function(e){return p("TDXApi.approveAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"approveAccount"))}},{key:"resetAccount",value:function(e,t){var r=this.buildCommandRequest("account/reset",{username:e,key:t});return(0,c.default)(r).catch(function(e){return p("TDXApi.resetAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"resetAccount"))}},{key:"verifyAccount",value:function(e,t){var r=this.buildCommandRequest("account/verify",{username:e,verified:t});return(0,c.default)(r).catch(function(e){return p("TDXApi.verifyAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"verifyAccount"))}},{key:"deleteAccount",value:function(e){var t=this.buildCommandRequest("account/delete",{username:e});return(0,c.default)(t).catch(function(e){return p("TDXApi.deleteAccount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteAccount"))}},{key:"addTrustedExchange",value:function(e){var t=this.buildCommandRequest("trustedConnection/create",e);return(0,c.default)(t).catch(function(e){return p("TDXApi.addTrustedExchange: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addTrustedExchange"))}},{key:"addResource",value:function(e,t){var r=this,n=this.buildCommandRequest("resource/create",e);return(0,c.default)(n).catch(function(e){return p("TDXApi.addResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addResource")).then(function(e){return t?r.waitForIndex(e.response.id).then(function(){return e}):e})}},{key:"updateResource",value:function(e,t){var r=this.buildCommandRequest("resource/update",o({id:e},t));return(0,c.default)(r).catch(function(e){return p("TDXApi.updateResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"updateResource"))}},{key:"moveResource",value:function(e,t,r){var n=this.buildCommandRequest("resource/move",{id:e,fromParentId:t,toParentId:r});return(0,c.default)(n).catch(function(e){return p("TDXApi.moveResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"moveResource"))}},{key:"deleteResource",value:function(e){var t=this.buildCommandRequest("resource/delete",{id:e});return(0,c.default)(t).catch(function(e){return p("TDXApi.deleteResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteResource"))}},{key:"rebuildResourceIndex",value:function(e){var t=this,r=this.buildCommandRequest("resource/index/rebuild",{id:e}),n=void 0;return(0,c.default)(r).catch(function(e){return p("TDXApi.rebuildResourceIndex: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"rebuildIndex")).then(function(e){return n=e,t.waitForIndex(n.response.id,"built")}).then(function(){return n})}},{key:"suspendResourceIndex",value:function(e){var t=this,r=this.buildCommandRequest("resource/index/suspend",{id:e}),n=void 0;return(0,c.default)(r).catch(function(e){return p("TDXApi.suspendResourceIndex: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"suspendIndex")).then(function(e){return n=e,t.waitForIndex(n.response.id,"suspended")}).then(function(){return n})}},{key:"addResourceAccess",value:function(e,t,r,n){var s=this.buildCommandRequest("resourceAccess/add",{rid:e,aid:t,src:r,acc:n});return(0,c.default)(s).catch(function(e){return p("TDXApi.addResourceAccess: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"addResourceAccess"))}},{key:"removeResourceAccess",value:function(e,t,r,n,s){var o=this.buildCommandRequest("resourceAccess/delete",{rid:e,aid:t,by:r,src:n,acc:s});return(0,c.default)(o).catch(function(e){return p("TDXApi.removeResourceAccess: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"removeResourceAccess"))}},{key:"setResourceShareMode",value:function(e,t){var r=this.buildCommandRequest("resource/setShareMode",{id:e,shareMode:t});return(0,c.default)(r).catch(function(e){return p("TDXApi.setResourceShareMode: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"setResourceShareMode"))}},{key:"setResourcePermissiveShare",value:function(e,t){var r=this.buildCommandRequest("resource/setPermissiveShare",{id:e,permissiveShare:t?"r":""});return(0,c.default)(r).catch(function(e){return p("TDXApi.setResourcePermissiveShare: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"setResourcePermissiveShare"))}},{key:"truncateResource",value:function(e){var t=this.buildCommandRequest("resource/truncate",{id:e});return(0,c.default)(t).catch(function(e){return p("TDXApi.truncateResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"truncateResource"))}},{key:"addData",value:function(e,t){var r={datasetId:e,payload:[].concat(t)},n=this.buildCommandRequest("dataset/data/createMany",r);return(0,c.default)(n).catch(function(e){return p("TDXApi.createData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"updateData"))}},{key:"updateData",value:function(e,t,r){var n={datasetId:e,payload:[].concat(t),__upsert:!!r},s=this.buildCommandRequest("dataset/data/updateMany",n);return(0,c.default)(s).catch(function(e){return p("TDXApi.updateData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"updateData"))}},{key:"patchData",value:function(e,t){var r={datasetId:e,payload:[].concat(t)},n=this.buildCommandRequest("dataset/data/upsertMany",r);return(0,c.default)(n).catch(function(e){return p("TDXApi.patchData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"patchData"))}},{key:"deleteData",value:function(e,t){var r=o({datasetId:e},t),n=this.buildCommandRequest("dataset/data/delete",r);return(0,c.default)(n).catch(function(e){return p("TDXApi.deleteData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteData"))}},{key:"deleteDataByQuery",value:function(e,t){var r={datasetId:e,query:t},n=this.buildCommandRequest("dataset/data/deleteQuery",r);return(0,c.default)(n).catch(function(e){return p("TDXApi.deleteDataByQuery: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteDataByQuery"))}},{key:"fileUpload",value:function(e,t,r){var n=new Request(this.config.commandHost+"/commandSync/resource/"+e+"/upload",{method:"POST",mode:"cors",headers:new Headers({Authorization:"Bearer "+this.accessToken,"Content-Disposition":'attachment; filename="'+t.name+'"',"Content-Length":t.size}),body:t}),s=(0,c.default)(n).catch(function(e){return p("TDXApi.fileUpload: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))});return r?s:s.then(function(e){return[e,e.text()]}).spread(function(e,t){return e.ok?Promise.resolve(t):Promise.reject((0,h.handleError)("fileUpload",{code:"failure",message:t}))})}},{key:"startDatabotInstance",value:function(e,t){var r={databotId:e,instanceData:t},n=this.buildCommandRequest("databot/startInstance",r);return(0,c.default)(n).catch(function(e){return p("TDXApi.startDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"startDatabotInstance"))}},{key:"stopDatabotInstance",value:function(e,t){var r={instanceId:e,mode:t},n=this.buildCommandRequest("databot/stopInstance",r);return(0,c.default)(n).catch(function(e){return p("TDXApi.stopDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"stopDatabotInstance"))}},{key:"deleteDatabotInstance",value:function(e){var t={instanceId:e},r=this.buildCommandRequest("databot/deleteInstance",t);return(0,c.default)(r).catch(function(e){return p("TDXApi.deleteDatabotInstance: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"deleteDatabotInstance"))}},{key:"sendDatabotHostCommand",value:function(e,t,r,n){var s={hostId:t,hostIp:r,hostPort:n,command:e},o=this.buildCommandRequest("databot/host/command",s);return(0,c.default)(o).catch(function(e){return p("TDXApi.sendDatabotHostCommand: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"sendDatabotHostCommand"))}},{key:"getZone",value:function(e){var t=this.buildQueryRequest("zones",{username:e});return(0,c.default)(t).catch(function(e){return p("TDXApi.getZone: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getZone"))}},{key:"getResource",value:function(e,t){var r=this.buildQueryRequest("resources/"+e);return(0,c.default)(r).catch(function(e){return p("TDXApi.getResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(function(e){return t?e.ok?e.json():404===e.status?null:(0,h.checkResponse)("getResource",e):(0,h.checkResponse)("getResource",e)})}},{key:"getResources",value:function(e,t,r){var n=this.buildQueryRequest("resources",e,t,r);return(0,c.default)(n).catch(function(e){return p("TDXApi.getResource: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getResources"))}},{key:"getResourcesWithSchema",value:function(e){var t={"schemaDefinition.parent":e};return this.getResources(t)}},{key:"getResourceAncestors",value:function(e){var t=this.buildQueryRequest("datasets/"+e+"/ancestors");return(0,c.default)(t).catch(function(e){return p("TDXApi.getDatasetAncestors: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getResourceAncestors"))}},{key:"getDatasetData",value:function(e,t,r,n){var s=this.buildQueryRequest("datasets/"+e+"/data",t,r,n);return(0,c.default)(s).catch(function(e){return p("TDXApi.getDatasetData: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getDatasetData"))}},{key:"getDatasetDataCount",value:function(e,t){var r=this.buildQueryRequest("datasets/"+e+"/count",t);return(0,c.default)(r).catch(function(e){return p("TDXApi.getDatasetDataCount: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getDatasetDataCount"))}},{key:"getDistinct",value:function(e,t,r,n,s){var o=this.buildQueryRequest("datasets/"+e+"/distinct?key="+t,r,n,s);return(0,c.default)(o).catch(function(e){return p("TDXApi.getDistinct: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getDatasetData"))}},{key:"getTDXToken",value:function(e){var t=this.buildQueryRequest("tdx-token/"+e);return(0,c.default)(t).catch(function(e){return p("TDXApi.getTDXToken: %s",e.message),Promise.reject(new Error(e.message+" - [network error]"))}).then(h.checkResponse.bind(null,"getTDXToken"))}},{key:"waitForResource",value:function(e,t,r,n){var s=this;return r=r||0,this.getResource(e).then(function(o){var a=t(o,r);return a instanceof Error?(f("waitForResource - check failed with error [%s]",a.message),Promise.reject(a)):a?o:n>=0&&r>n?(f("waitForResource - giving up after %d attempts",r),Promise.reject(new Error("gave up waiting for "+e+" after "+r+" attempts"))):(f("waitForResource - waiting for %d msec",1e3),Promise.delay(1e3).then(function(){return s.waitForResource(e,t,r+1,n)}))}).catch(function(o){if("TDXApiError"!==o.name)return Promise.reject(o);try{var a=JSON.parse(o.message),u=JSON.parse(a.failure);return"NotFoundError"===u.code||"UnauthorizedError"===u.code?(f("waitForResource - ignoring error %s",o.message),Promise.delay(1e3).then(function(){return s.waitForResource(e,t,r+1,n)})):Promise.reject(o)}catch(e){return Promise.reject(o)}})}},{key:"waitForIndex",value:function(e,t,r){void 0===r&&(r=-1),t=t||"built";var n="",s=function(e,s){f("builtIndexCheck: %s",e?e.indexStatus:"no dataset");var o=void 0;return o=e&&"error"===e.indexStatus?!n||("error"!==n?new Error("index entered error status"):!(s>Math.min(r,15))||new Error("index still in error status after "+s+" retries")):!!e&&e.indexStatus===t,e&&!n&&(n=e.indexStatus),o};return this.waitForResource(e,s,0,r)}}]),e}();t.default=g,e.exports=t.default}])});